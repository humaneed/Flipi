<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#4A7C91" />
  <title>Kidsneed ‚Äì Kinder-Flipper (Sticker Pinball)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Kidsneed-ish calm premium */
      --bg:#F5F0E8;
      --card:#FFFFFF;
      --muted:#EDE8DC;

      --ink:#2D2A26;
      --ink2:#6B665C;

      --accent:#4A7C91;     /* blau-gr√ºn */
      --mint:#7BA08A;       /* ruhig */
      --sun:#E8C547;        /* warmes gelb */
      --coral:#E07A5F;      /* weich */
      --violet:#7B6EA8;     /* leise */

      --r-lg:24px;
      --shadow:0 8px 24px rgba(45,42,38,.12);
      --shadow2:0 2px 10px rgba(45,42,38,.10);

      --s2:12px; --s3:16px; --s4:24px;
      --maxw:560px;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      font-family:Nunito, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      overscroll-behavior:none;
      touch-action:none;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:calc(env(safe-area-inset-top) + var(--s3)) var(--s3) calc(env(safe-area-inset-bottom) + var(--s3));
    }

    .frame{
      width:100%;
      max-width:var(--maxw);
      height:min(92dvh, 920px);
      background:var(--card);
      border:3px solid var(--ink);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      height:78px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--s2);
      padding:0 var(--s3);
      border-bottom:3px solid var(--ink);
      background:linear-gradient(180deg, rgba(255,255,255,1), rgba(237,232,220,.55));
    }

    .title{display:flex; flex-direction:column; gap:4px; min-width:0;}
    .title b{
      font-size:18px; font-weight:900; letter-spacing:-.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .title small{
      font-weight:900; font-size:12px; letter-spacing:.10em;
      color:var(--ink2); text-transform:uppercase;
    }

    .chips{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:2px solid var(--ink);
      background:var(--muted);
      font-weight:900;
      user-select:none;
      white-space:nowrap;
    }
    .pill span{
      color:var(--ink2); font-weight:900; font-size:12px; letter-spacing:.10em; text-transform:uppercase;
    }
    .pill b{font-size:14px;}
    .btn{
      border:2px solid var(--ink);
      background:var(--muted);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:translateY(1px);}

    .stage{
      position:relative;
      flex:1;
      padding:var(--s3);
      background:
        radial-gradient(900px 340px at 50% 0%, rgba(74,124,145,.12), transparent 60%),
        var(--card);
    }

    .board{
      position:absolute;
      inset:var(--s3);
      border-radius:var(--r-lg);
      border:3px solid var(--ink);
      box-shadow:var(--shadow);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(237,232,220,.65), rgba(255,255,255,1));
    }

    canvas{width:100%; height:100%; display:block;}

    /* Touch zones: links/rechts halten */
    .zones{position:absolute; inset:0; display:flex;}
    .zone{flex:1; background:transparent; touch-action:none;}

    .toast{
      position:absolute;
      left:50%; top:14px;
      transform:translateX(-50%) translateY(-6px);
      padding:10px 14px;
      border-radius:999px;
      background:rgba(45,42,38,.92);
      color:#fff;
      font-weight:900;
      opacity:0;
      transition:opacity .16s ease, transform .16s ease;
      pointer-events:none;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0);}

    .overlay{
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(245,240,232,.72);
      backdrop-filter:blur(6px);
      padding:var(--s3);
    }
    .panel{
      width:min(440px, 100%);
      background:var(--card);
      border:3px solid var(--ink);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      padding:var(--s4);
    }
    .panel h2{margin:0 0 var(--s2); font-size:20px; font-weight:900;}
    .panel p{margin:0 0 var(--s3); color:var(--ink2); font-weight:800; line-height:1.35;}
    .panel .row{display:flex; gap:var(--s2); justify-content:space-between; flex-wrap:wrap;}
    .hint{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      border:2px dashed rgba(45,42,38,.18);
      background:rgba(237,232,220,.55);
      color:var(--ink2);
      font-weight:900;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="topbar">
      <div class="title">
        <b>Sticker-Pinball</b>
        <small>Kinder-Flipper ¬∑ ruhig & premium</small>
      </div>

      <div class="chips">
        <div class="pill" title="Mission">
          <span>‚≠ê Sterne</span><b id="stars">0</b><span>/</span><b id="goal">15</b>
        </div>
        <div class="pill" title="Bonus-Stufe"><span>Bonus</span><b id="bonus">0</b></div>
        <div class="pill" title="B√§lle"><span>‚ù§</span><b id="lives">3</b></div>
        <div class="pill" title="Punkte"><span>Score</span><b id="score">0</b></div>
        <button class="btn" id="btnPause" title="Pause">‚è∏</button>
        <button class="btn" id="btnReset" title="Neu">‚Üª</button>
      </div>
    </div>

    <div class="stage">
      <div class="board" id="board">
        <canvas id="cv"></canvas>
        <div class="toast" id="toast">Los geht‚Äôs!</div>

        <div class="zones" aria-hidden="true">
          <div class="zone" id="zl"></div>
          <div class="zone" id="zr"></div>
        </div>

        <div class="overlay" id="over">
          <div class="panel">
            <h2 id="overTitle">Pause</h2>
            <p id="overText">
              Steuerung:<br>
              <b>Links halten</b> = linker Flipper ¬∑ <b>Rechts halten</b> = rechter Flipper / Plunger laden.<br>
              Wenn der Ball im Plunger ist: <b>rechts halten</b> (laden) ‚Üí <b>loslassen</b> (schie√üen).
            </p>
            <div class="row">
              <button class="btn" id="overResume">Weiter</button>
              <button class="btn" id="overSound">Sound: An</button>
              <button class="btn" id="overEasy">Easy: An</button>
            </div>
            <div class="hint">
              Ziel: Sammle ‚≠ê Sterne. Wenn du genug hast, gibt‚Äôs ein <b>Sticker-Feuerwerk</b> und Bonus-Punkte.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // ===== Kinder-Settings (ruhig, fair, ‚Äûnicht frustig‚Äú) =====
  const CFG = {
    tableW: 400,
    tableH: 700,

    // physics
    ballR: 9,
    gravity: 1180,
    damping: 0.996,
    maxSpeed: 1500,

    wallRest: 0.93,
    bumperRest: 1.05,
    slingRest: 1.07,
    flipperRest: 0.90,

    // flippers
    flLen: 78,
    flWidth: 14,
    flRestAngle: 0.50,
    flUpAngle: -0.72,
    flSnap: 24,
    flPunch: 220,

    // plunger
    plungerMax: 1350,
    plCharge: 1100,
    plMin: 120,

    // kid-friendly pacing
    lives: 3,
    ballSave: 1.6,     // more forgiving
    easyMode: true,    // default ON

    // mission
    starGoal: 15,

    // scoring
    hitScore: 15,
    bumperScore: 40,
    slingScore: 10,
    stickerBonusBase: 300,

    // confetti
    confettiCount: 18,
  };

  // DOM
  const cv = document.getElementById("cv");
  const boardEl = document.getElementById("board");
  const ctx = cv.getContext("2d");

  const elStars = document.getElementById("stars");
  const elGoal  = document.getElementById("goal");
  const elBonus = document.getElementById("bonus");
  const elLives = document.getElementById("lives");
  const elScore = document.getElementById("score");
  const toast = document.getElementById("toast");

  const btnReset = document.getElementById("btnReset");
  const btnPause = document.getElementById("btnPause");

  const over = document.getElementById("over");
  const overTitle = document.getElementById("overTitle");
  const overResume = document.getElementById("overResume");
  const overSound = document.getElementById("overSound");
  const overEasy = document.getElementById("overEasy");

  const zl = document.getElementById("zl");
  const zr = document.getElementById("zr");

  // helpers
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const hypot = (x,y)=>Math.sqrt(x*x+y*y);

  function showToast(txt){
    toast.textContent = txt;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 620);
  }

  // ===== Responsive fit =====
  let DPR = 1, scale = 1, offX = 0, offY = 0, pxW = 0, pxH = 0;
  function resize(){
    const r = boardEl.getBoundingClientRect();
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    pxW = Math.floor(r.width * DPR);
    pxH = Math.floor(r.height * DPR);
    cv.width = pxW;
    cv.height = pxH;

    const sx = pxW / CFG.tableW;
    const sy = pxH / CFG.tableH;
    scale = Math.min(sx, sy);

    offX = (pxW - CFG.tableW * scale) * 0.5;
    offY = (pxH - CFG.tableH * scale) * 0.5;

    ctx.setTransform(1,0,0,1,0,0);
  }
  window.addEventListener("resize", resize, {passive:true});
  resize();

  // ===== Minimal sound =====
  let audioCtx=null;
  let soundOn=true;
  function beep(freq=520, dur=0.06, gain=0.035, type="sine"){
    if(!soundOn) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(gain, t0);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0); o.stop(t0+dur);
    }catch(e){}
  }

  function updateOverlayButtons(){
    overSound.textContent = "Sound: " + (soundOn ? "An" : "Aus");
    overEasy.textContent  = "Easy: "  + (CFG.easyMode ? "An" : "Aus");
  }

  // ===== Table geometry =====
  let walls=[], slings=[], bumpers=[], stars=[], gates=[];
  function seg(x1,y1,x2,y2){ return {x1,y1,x2,y2}; }
  function circ(x,y,r, kind, data){ return {x,y,r, kind, data, glow:0}; }

  function buildTable(){
    const W=CFG.tableW, H=CFG.tableH;
    walls=[]; slings=[]; bumpers=[]; stars=[]; gates=[];

    const pad=12;
    const left=pad, right=W-pad, top=pad, bot=H-pad;

    // drain gap
    const drainGap = 140;
    const mid = W/2;

    // outer walls (rounded feel via drawing; physics is segments)
    walls.push(
      seg(left, top, right, top),
      seg(left, top, left, bot-190),
      seg(right, top, right, bot-190),
      seg(left, bot-190, mid - drainGap/2, bot),
      seg(mid + drainGap/2, bot, right, bot-190),
    );

    // plunger lane (open exit + guide)
    const plA = W*0.80;
    const plB = W*0.92;
    walls.push(seg(plB, bot, plB, H*0.10));      // outer wall
    walls.push(seg(plA, bot, plA, H*0.42));      // inner wall stops -> exit
    walls.push(seg(W*0.16, H*0.14, W*0.72, H*0.14)); // top shelf (doesn't close lane)
    walls.push(seg(plA, H*0.42, W*0.64, H*0.30));    // guide ramp

    // gentle ramps
    walls.push(
      seg(W*0.18, H*0.48, W*0.40, H*0.58),
      seg(W*0.82, H*0.48, W*0.60, H*0.58),
    );

    // slings (kid-friendly: soft)
    slings.push(
      seg(W*0.20, H*0.70, W*0.34, H*0.80),
      seg(W*0.34, H*0.80, W*0.24, H*0.86),
      seg(W*0.24, H*0.86, W*0.20, H*0.70),

      seg(W*0.80, H*0.70, W*0.66, H*0.80),
      seg(W*0.66, H*0.80, W*0.76, H*0.86),
      seg(W*0.76, H*0.86, W*0.80, H*0.70),
    );

    // bumpers as ‚ÄúSticker-Tiere‚Äù
    bumpers.push(
      circ(W*0.42, H*0.22, 25, "bumper", {emoji:"üêª", color:"#7BA08A", star:1}),
      circ(W*0.58, H*0.22, 25, "bumper", {emoji:"üê∏", color:"#4A7C91", star:1}),
      circ(W*0.50, H*0.33, 30, "bumper", {emoji:"ü¶ä", color:"#E07A5F", star:2}),
    );

    // star targets (collect)
    stars.push(
      circ(W*0.30, H*0.50, 13, "star", {emoji:"‚≠ê", color:"#E8C547", star:1}),
      circ(W*0.70, H*0.50, 13, "star", {emoji:"‚≠ê", color:"#E8C547", star:1}),
      circ(W*0.50, H*0.62, 13, "star", {emoji:"‚≠ê", color:"#E8C547", star:1}),
    );

    // gentle ‚Äúgate‚Äù (bonus lane top)
    gates.push(circ(W*0.86, H*0.18, 14, "gate", {emoji:"üåà", color:"#7B6EA8", star:3, cd:0.8, t:0}));
  }

  // ===== Physics helpers =====
  function closestPoint(px,py, x1,y1,x2,y2){
    const dx=x2-x1, dy=y2-y1;
    const l2 = dx*dx+dy*dy || 1;
    let t = ((px-x1)*dx + (py-y1)*dy)/l2;
    t = clamp(t,0,1);
    return { x:x1+t*dx, y:y1+t*dy };
  }

  function reflect(ball, nx, ny, rest){
    const dot = ball.vx*nx + ball.vy*ny;
    if(dot < 0){
      ball.vx = (ball.vx - 2*dot*nx) * rest;
      ball.vy = (ball.vy - 2*dot*ny) * rest;
    }
  }

  function collideSegment(ball, s, rest, boost=1){
    const cp = closestPoint(ball.x,ball.y, s.x1,s.y1,s.x2,s.y2);
    const dx = ball.x - cp.x, dy = ball.y - cp.y;
    const dist = Math.sqrt(dx*dx+dy*dy) || 0.0001;
    const overlap = ball.r - dist;
    if(overlap > 0){
      const nx = dx/dist, ny = dy/dist;
      ball.x += nx*(overlap+0.5);
      ball.y += ny*(overlap+0.5);
      reflect(ball, nx, ny, rest);
      ball.vx *= boost; ball.vy *= boost;
      return true;
    }
    return false;
  }

  function collideCircle(ball, c, rest, kick=60){
    const dx=ball.x-c.x, dy=ball.y-c.y;
    const dist = Math.sqrt(dx*dx+dy*dy) || 0.0001;
    const minD = ball.r + c.r;
    if(dist < minD){
      const nx = dx/dist, ny = dy/dist;
      const overlap = minD - dist;
      ball.x += nx*(overlap+0.6);
      ball.y += ny*(overlap+0.6);
      reflect(ball, nx, ny, rest);
      ball.vx += nx*kick;
      ball.vy += ny*kick;
      return true;
    }
    return false;
  }

  // ===== Game state =====
  const ball = { x:0, y:0, vx:0, vy:0, r:CFG.ballR, inPlunger:true, saveT:0 };
  let plPower=0;

  const flL = { side:"L", px:120, py:CFG.tableH-60, len:CFG.flLen, ang:0, targ:0, av:0 };
  const flR = { side:"R", px:CFG.tableW-170, py:CFG.tableH-60, len:CFG.flLen, ang:0, targ:0, av:0 };

  let holdL=false, holdR=false, prevHoldR=false;
  let score=0, lives=CFG.lives;
  let starCount=0, bonusLevel=0;
  let paused=false;
  let confetti=[];

  function resetBall(){
    ball.x = CFG.tableW-25;
    ball.y = CFG.tableH-55;
    ball.vx = 0; ball.vy = 0;
    ball.inPlunger = true;
    ball.saveT = 0;
    plPower = 0;
  }

  function resetGame(){
    buildTable();
    score=0; lives=CFG.lives;
    starCount=0; bonusLevel=0;
    confetti.length=0;
    resetBall();
    updateHUD();
    showToast("‚≠ê Sammle Sterne!");
    beep(520,0.07,0.03,"sine");
  }

  function updateHUD(){
    elStars.textContent = String(starCount);
    elGoal.textContent = String(CFG.starGoal);
    elBonus.textContent = String(bonusLevel);
    elLives.textContent = String(lives);
    elScore.textContent = String(score);
  }

  function addStars(n, label){
    starCount += n;
    score += (n * 35) + (bonusLevel * 10);
    if(label) showToast(label);

    // Mission complete -> sticker bonus
    if(starCount >= CFG.starGoal){
      starCount = 0;
      bonusLevel = Math.min(9, bonusLevel + 1);
      score += CFG.stickerBonusBase + (bonusLevel * 120);
      makeConfetti();
      showToast("üéâ Sticker-Bonus!");
      beep(760,0.08,0.05,"triangle");
      beep(920,0.07,0.045,"sine");

      // kid-friendly: sometimes an extra ball
      if(CFG.easyMode && bonusLevel % 3 === 0 && lives < 5){
        lives++;
        showToast("‚ù§ Extra Ball!");
        beep(660,0.08,0.05,"sine");
      }
    }
    updateHUD();
  }

  // ===== Confetti =====
  function makeConfetti(){
    confetti.length = 0;
    const colors = ["#4A7C91","#7BA08A","#E8C547","#E07A5F","#7B6EA8"];
    for(let i=0;i<CFG.confettiCount;i++){
      confetti.push({
        x: CFG.tableW*0.50 + (Math.random()*40-20),
        y: 80 + Math.random()*20,
        vx: Math.random()*220 - 110,
        vy: Math.random()*-220 - 90,
        g: 520 + Math.random()*260,
        r: 4 + Math.random()*4,
        rot: Math.random()*Math.PI*2,
        vr: Math.random()*6 - 3,
        c: colors[i % colors.length],
        t: 1.2 + Math.random()*0.6
      });
    }
  }

  // ===== Input =====
  function bindHold(el, setFn){
    el.addEventListener("pointerdown", (e)=>{ e.preventDefault(); setFn(true); }, {passive:false});
    el.addEventListener("pointerup", (e)=>{ e.preventDefault(); setFn(false); }, {passive:false});
    el.addEventListener("pointercancel", (e)=>{ e.preventDefault(); setFn(false); }, {passive:false});
    el.addEventListener("pointerleave", (e)=>{ e.preventDefault(); setFn(false); }, {passive:false});
  }
  bindHold(zl, v=>holdL=v);
  bindHold(zr, v=>holdR=v);

  window.addEventListener("keydown", (e)=>{
    if(e.repeat) return;
    if(e.key==="ArrowLeft" || e.key==="a") holdL=true;
    if(e.key==="ArrowRight" || e.key==="l") holdR=true;
    if(e.key===" ") tryLaunch();
    if(e.key==="Escape") togglePause();
  });
  window.addEventListener("keyup", (e)=>{
    if(e.key==="ArrowLeft" || e.key==="a") holdL=false;
    if(e.key==="ArrowRight" || e.key==="l") holdR=false;
  });

  // ===== Pause / Settings =====
  function togglePause(force){
    paused = (typeof force === "boolean") ? force : !paused;
    over.style.display = paused ? "flex" : "none";
    overTitle.textContent = paused ? "Pause" : " ";
    updateOverlayButtons();
  }
  btnPause.addEventListener("click", ()=>togglePause());
  overResume.addEventListener("click", ()=>togglePause(false));
  overSound.addEventListener("click", ()=>{ soundOn=!soundOn; updateOverlayButtons(); beep(420,0.05,0.03); });
  overEasy.addEventListener("click", ()=>{ CFG.easyMode=!CFG.easyMode; updateOverlayButtons(); showToast(CFG.easyMode ? "Easy an" : "Easy aus"); });
  btnReset.addEventListener("click", ()=>{ togglePause(false); resetGame(); });

  // prevent iOS scroll
  document.addEventListener("touchmove", (e)=>e.preventDefault(), {passive:false});

  // ===== Flippers =====
  function flipperEndpoints(f){
    const x2 = f.px + Math.cos(f.ang)*f.len;
    const y2 = f.py + Math.sin(f.ang)*f.len;
    return {x1:f.px, y1:f.py, x2, y2};
  }

  function updateFlippers(dt){
    const restL = +CFG.flRestAngle;
    const upL   = CFG.flUpAngle;
    const restR = Math.PI - CFG.flRestAngle;
    const upR   = Math.PI - CFG.flUpAngle;

    flL.targ = holdL ? upL : restL;
    flR.targ = holdR ? upR : restR;

    const move = (f)=>{
      const prev = f.ang;
      f.ang += (f.targ - f.ang) * clamp(CFG.flSnap*dt,0,1);
      f.av = (f.ang - prev) / dt;
    };
    move(flL); move(flR);
  }

  // ===== Launch =====
  function tryLaunch(){
    if(!ball.inPlunger) return;
    if(plPower < CFG.plMin) return;

    ball.inPlunger = false;

    // kid-friendly: always enters the field reliably
    ball.vx = -55 + (Math.random()*18 - 9);
    ball.vy = -plPower;

    // nudge into playfield
    ball.x = CFG.tableW * 0.78;
    ball.saveT = CFG.ballSave;

    plPower = 0;
    beep(520,0.06,0.03,"sine");
  }

  // ===== Fixed timestep loop =====
  let last = performance.now();
  let acc = 0;
  const STEP = 1/120;

  function physicsStep(dt){
    if(paused) return;

    updateFlippers(dt);

    // update gate cooldowns
    for(const g of gates){
      g.data.t = Math.max(0, g.data.t - dt);
    }

    // plunger: hold right to charge, release to shoot
    if(ball.inPlunger){
      ball.x = CFG.tableW - 25;
      ball.y = clamp(ball.y, CFG.tableH-95, CFG.tableH-55);

      if(holdR){
        plPower = clamp(plPower + CFG.plCharge*dt, 0, CFG.plungerMax);
      }
      if(prevHoldR && !holdR){
        tryLaunch();
      }
      prevHoldR = holdR;
      return;
    }

    // integrate
    const grav = CFG.easyMode ? (CFG.gravity*0.95) : CFG.gravity;
    ball.vy += grav * dt;
    ball.x += ball.vx * dt;
    ball.y += ball.vy * dt;

    // damping
    const damp = CFG.easyMode ? (CFG.damping*1.0005) : CFG.damping;
    ball.vx *= damp;
    ball.vy *= damp;

    // speed cap
    const sp = hypot(ball.vx,ball.vy);
    const cap = CFG.easyMode ? (CFG.maxSpeed*0.90) : CFG.maxSpeed;
    if(sp > cap){
      const s = cap/sp;
      ball.vx *= s; ball.vy *= s;
    }

    // collisions: walls
    for(const w of walls){
      if(collideSegment(ball, w, CFG.wallRest, 1)) {
        score += CFG.hitScore + Math.min(20, bonusLevel*2);
      }
    }

    // slings
    for(const s of slings){
      if(collideSegment(ball, s, CFG.slingRest, 1.01)){
        score += CFG.slingScore;
        beep(420,0.04,0.02,"triangle");
      }
    }

    // flippers + gentle punch when pressed
    for(const f of [flL, flR]){
      const e = flipperEndpoints(f);
      const hit = collideSegment(ball, {x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}, CFG.flipperRest, 1);
      if(hit){
        const pressing = (f.side==="L" && holdL) || (f.side==="R" && holdR);
        if(pressing){
          const punch = CFG.easyMode ? (CFG.flPunch*0.85) : CFG.flPunch;
          ball.vx += Math.cos(f.ang) * punch;
          ball.vy += Math.sin(f.ang) * punch;
        }
        beep(520,0.035,0.015,"sine");
      }
    }

    // bumpers
    for(const b of bumpers){
      if(collideCircle(ball, b, CFG.bumperRest, CFG.easyMode ? 55 : 70)){
        b.glow = 1;
        score += CFG.bumperScore + bonusLevel*5;
        addStars(b.data.star, b.data.emoji + " +" + b.data.star);
        beep(660,0.06,0.03,"sine");
      }
      b.glow = Math.max(0, b.glow - 3*dt);
    }

    // star targets (smaller, gentle, give stars)
    for(const s of stars){
      if(collideCircle(ball, s, 1.02, 40)){
        s.glow = 1;
        addStars(s.data.star, "‚≠ê +" + s.data.star);
        beep(740,0.05,0.025,"triangle");
      }
      s.glow = Math.max(0, s.glow - 4*dt);
    }

    // gate (cooldown)
    for(const g of gates){
      if(g.data.t > 0) continue;
      const dx=ball.x-g.x, dy=ball.y-g.y;
      const rr=(ball.r+g.r);
      if(dx*dx+dy*dy <= rr*rr){
        g.data.t = g.data.cd;
        g.glow = 1;
        addStars(g.data.star, g.data.emoji + " +" + g.data.star);
        score += 120 + bonusLevel*20;
        beep(820,0.07,0.03,"sine");
      }
      g.glow = Math.max(0, g.glow - 3*dt);
    }

    // ball save
    if(ball.saveT > 0) ball.saveT = Math.max(0, ball.saveT - dt);

    // drain
    if(ball.y > CFG.tableH + 55){
      if(ball.saveT > 0){
        resetBall();
        showToast("üõü Ball Save!");
        beep(520,0.06,0.03,"sine");
        updateHUD();
        return;
      }
      lives--;
      updateHUD();

      if(lives > 0){
        resetBall();
        showToast("‚ù§ Weiter!");
        beep(220,0.08,0.03,"triangle");
      } else {
        paused = true;
        over.style.display = "flex";
        overTitle.textContent = "Spiel vorbei";
      }
    }

    updateHUD();

    // confetti physics
    if(confetti.length){
      for(const p of confetti){
        p.vy += p.g*dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.rot += p.vr*dt;
        p.t -= dt;
      }
      confetti = confetti.filter(p => p.t > 0 && p.y < CFG.tableH+80);
    }
  }

  // ===== Draw =====
  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,pxW,pxH);

    ctx.setTransform(scale,0,0,scale, offX, offY);

    // background wash
    const bg = ctx.createLinearGradient(0,0,0,CFG.tableH);
    bg.addColorStop(0, "rgba(74,124,145,0.10)");
    bg.addColorStop(1, "rgba(74,124,145,0.00)");
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,CFG.tableW,CFG.tableH);

    // playful dots (very subtle)
    ctx.save();
    ctx.globalAlpha = 0.06;
    ctx.fillStyle = "rgba(45,42,38,1)";
    for(let y=24;y<CFG.tableH;y+=36){
      for(let x=18;x<CFG.tableW;x+=36){
        ctx.beginPath();
        ctx.arc(x + (y%72?8:0), y, 1.2, 0, Math.PI*2);
        ctx.fill();
      }
    }
    ctx.restore();

    // draw ‚Äúwood-ish‚Äù rails (visual only)
    ctx.save();
    ctx.globalAlpha = 0.12;
    ctx.strokeStyle = "rgba(45,42,38,1)";
    ctx.lineWidth = 18;
    ctx.lineCap="round";
    // approximate outer rail (visual)
    ctx.beginPath();
    ctx.moveTo(14, 18);
    ctx.lineTo(CFG.tableW-14, 18);
    ctx.lineTo(CFG.tableW-14, CFG.tableH-210);
    ctx.lineTo(CFG.tableW*0.62, CFG.tableH-26);
    ctx.moveTo(CFG.tableW*0.38, CFG.tableH-26);
    ctx.lineTo(14, CFG.tableH-210);
    ctx.lineTo(14, 18);
    ctx.stroke();
    ctx.restore();

    // physics walls
    ctx.strokeStyle="rgba(45,42,38,0.22)";
    ctx.lineWidth=6;
    ctx.lineCap="round";
    for(const w of walls){
      ctx.beginPath(); ctx.moveTo(w.x1,w.y1); ctx.lineTo(w.x2,w.y2); ctx.stroke();
    }

    // slings (mint)
    ctx.strokeStyle="rgba(123,160,138,0.40)";
    ctx.lineWidth=6;
    for(const s of slings){
      ctx.beginPath(); ctx.moveTo(s.x1,s.y1); ctx.lineTo(s.x2,s.y2); ctx.stroke();
    }

    // gate + stars + bumpers as stickers
    drawStickerCircles(gates, true);
    drawStickerCircles(stars, false);
    drawStickerCircles(bumpers, true);

    // flippers
    drawFlipper(flL);
    drawFlipper(flR);

    // plunger lane highlight
    ctx.save();
    ctx.globalAlpha=0.10;
    ctx.fillStyle="rgba(74,124,145,1)";
    ctx.fillRect(CFG.tableW*0.80, CFG.tableH*0.52, (CFG.tableW*0.92-CFG.tableW*0.80), CFG.tableH*0.38);
    ctx.restore();

    // plunger bar
    if(ball.inPlunger && plPower>0){
      const frac = clamp(plPower/CFG.plungerMax,0,1);
      ctx.save();
      ctx.globalAlpha=0.70;
      ctx.fillStyle="rgba(74,124,145,1)";
      const h = frac*210;
      ctx.fillRect(CFG.tableW-10, CFG.tableH-55-h, 6, h);
      ctx.restore();

      // tiny hint icon
      ctx.save();
      ctx.globalAlpha=0.9;
      ctx.font="900 12px Nunito";
      ctx.fillStyle="rgba(45,42,38,0.65)";
      ctx.fillText("HALTEN", CFG.tableW-86, CFG.tableH-80-h*0.4);
      ctx.restore();
    }

    // ball
    ctx.fillStyle="rgba(255,255,255,0.97)";
    ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=2;
    ctx.strokeStyle="rgba(45,42,38,0.20)";
    ctx.stroke();

    // ball save halo
    if(!ball.inPlunger && ball.saveT>0){
      ctx.save();
      ctx.globalAlpha=0.12;
      ctx.strokeStyle="rgba(74,124,145,1)";
      ctx.lineWidth=6;
      ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r+9,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }

    // confetti
    if(confetti.length){
      for(const p of confetti){
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = p.c;
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        ctx.restore();
      }
    }
  }

  function drawStickerCircles(arr, withBorder){
    for(const c of arr){
      const glow = c.glow || 0;
      const color = (c.data && c.data.color) ? c.data.color : "#4A7C91";

      // glow ring
      ctx.save();
      ctx.globalAlpha = 0.10 + 0.18*glow;
      ctx.fillStyle = color;
      ctx.beginPath(); ctx.arc(c.x,c.y,c.r+10,0,Math.PI*2); ctx.fill();
      ctx.restore();

      // sticker body
      ctx.fillStyle="rgba(255,255,255,0.94)";
      ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill();

      if(withBorder){
        ctx.lineWidth=2;
        ctx.strokeStyle="rgba(45,42,38,0.18)";
        ctx.stroke();
      }

      // emoji
      const em = c.data?.emoji || "";
      if(em){
        ctx.save();
        ctx.font = `900 ${Math.max(12, c.r)}px Nunito`;
        // emoji sizes behave better with normal font
        ctx.font = `${Math.max(14, c.r)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText(em, c.x, c.y+1);
        ctx.restore();
      }
    }
  }

  function drawFlipper(f){
    const e = flipperEndpoints(f);
    ctx.lineCap="round";

    // base
    ctx.lineWidth = CFG.flWidth;
    ctx.strokeStyle="rgba(45,42,38,0.34)";
    ctx.beginPath(); ctx.moveTo(e.x1,e.y1); ctx.lineTo(e.x2,e.y2); ctx.stroke();

    // highlight tint
    ctx.lineWidth = Math.max(4, CFG.flWidth-6);
    ctx.strokeStyle="rgba(123,160,138,0.70)"; /* mint */
    ctx.beginPath(); ctx.moveTo(e.x1,e.y1); ctx.lineTo(e.x2,e.y2); ctx.stroke();
  }

  // ===== Main loop =====
  function loop(now){
    const dt = Math.min(0.05, (now-last)/1000);
    last = now;

    acc += dt;
    while(acc >= STEP){
      physicsStep(STEP);
      acc -= STEP;
    }
    draw();
    requestAnimationFrame(loop);
  }

  // ===== Start =====
  buildTable();
  resetGame();
  updateOverlayButtons();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
